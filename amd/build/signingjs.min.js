define(["jquery"],function(a){return{debug:false,isSetUp:false,mousePressed:undefined,lastX:undefined,lastY:undefined,ctx:[],canvas:[],drawing:undefined,mousePos:undefined,lastPos:undefined,init:function(g){var f=this;if(f.debug){console.log("filter_signature/signingjs:initialize(uniqid)",g)}a("#canvas-"+g).attr("data-uniqid",g);var c=document.getElementById("canvas-"+g);f.canvas[g]=c;c.setAttribute("height",Math.ceil(c.offsetWidth/1000*320));c.setAttribute("data-uniqid",g);if(!this.isSetUp){var b=("ontouchstart" in window)||window.DocumentTouch&&document instanceof DocumentTouch;if(f.debug){console.log("filter_signature/signingjs:initialize - setup handlers")}c.addEventListener((b?"touchstart":"mousedown"),f.eventStart);c.addEventListener((b?"touchmove":"mousemove"),f.eventMove);c.addEventListener((b?"touchend":"mouseup"),f.eventStop);document.body.addEventListener("touchstart",f.eventStartBody,false);document.body.addEventListener("touchmove",f.eventMoveBody,false);document.body.addEventListener("touchend",f.eventStopBody,false);a(window).on("resize",f.eventResize,false)}if(document.getElementById("image-"+g)!=null){var e=document.getElementById("image-"+g);return}f.ctx[g]=c.getContext("2d");var d=c.getBoundingClientRect();if(f.debug){console.log("set bounds to ",d)}c.width=d.width;c.height=d.height;c.strokeStyle="#000";c.lineWidth=1;f.drawing=false;f.mousePos={x:0,y:0};f.lastPos=f.mousePos;a("#clearCanvas-"+g).bind("click",function(){if(f.debug){console.log("Cleared",g)}f.clearCanvas(f.canvas[g],f.ctx[g])});a("#id_submitbutton-"+g).click(function(){var h=a("#contextid-"+g).val();var j=a("#subkey-"+g).val();var i=a("#canvas-"+g)[0].toDataURL();if(f.debug){console.log("Submitted",g,h,j,i)}a("#id_signing-"+g).val(i);require(["core/ajax"],function(k){k.call([{methodname:"filter_signature_sign",args:{contextid:h,subkey:j,signature:i},done:function(l){if(f.debug){console.log("Answer is ",l)}},fail:function(){}}])})});if(f.debug){console.log("Signing handlers are",this.handlers)}},getMousePos:function(e,c,d){var b=("ontouchstart" in window)||window.DocumentTouch&&document instanceof DocumentTouch;var f=c.getBoundingClientRect();return{x:(b?d.touches[0].clientX:d.clientX)-f.left,y:(b?d.touches[0].clientY:d.clientY)-f.top}},renderCanvas:function(b){require(["filter_signature/signingjs"],function(c){if(c.debug){console.log("renderCanvas",b)}if(c.drawing){c.ctx[b].moveTo(c.lastPos.x,c.lastPos.y);c.ctx[b].lineTo(c.mousePos.x,c.mousePos.y);c.ctx[b].stroke();c.lastPos=c.mousePos}})},clearCanvas:function(c,b){b.clearRect(0,0,c.width,c.height);c.width=c.width},eventStart:function(c){var b=a(this).attr("data-uniqid");require(["filter_signature/signingjs"],function(d){if(d.debug){console.log("start",b,d.canvas[b])}c.preventDefault();c.stopPropagation();d.drawing=true;d.lastPos=d.getMousePos(d,d.canvas[b],c);d.mousePos=d.lastPos})},eventStartBody:function(c){var b=a(this).attr("data-uniqid");require(["filter_signature/signingjs"],function(d){if(d.debug){console.log("bodystart",this)}if(typeof b!=="undefined"){if(c.target==d.canvas[b]){c.preventDefault();c.stopPropagation()}}})},eventMove:function(c){var b=a(this).attr("data-uniqid");require(["filter_signature/signingjs"],function(d){if(typeof b!=="undefined"){if(d.debug){console.log("move",b,d.canvas[b])}c.preventDefault();c.stopPropagation();d.mousePos=d.getMousePos(d,d.canvas[b],c);if(d.drawing){d.renderCanvas(b)}}})},eventMoveBody:function(c){var b=a(this).attr("data-uniqid");require(["filter_signature/signingjs"],function(d){if(d.debug){console.log("bodystart",this)}if(typeof b!=="undefined"){if(c.target==d.canvas[b]){c.preventDefault();c.stopPropagation()}}})},eventResize:function(){require(["filter_signature/signingjs"],function(b){b.canvas.forEach(function(g){var c=b.canvas[g].width,e=b.canvas[g].height;var d=b.ctx[g].getImageData(0,0,c,e);var f=b.canvas[g].getBoundingClientRect();b.canvas[g].width=f.width;b.canvas[g].height=f.height;c=b.canvas[g].width,e=b.canvas[g].height;b.canvas[g].putImageData(d,0,0)})})},eventStop:function(c){var b=a(this).attr("data-uniqid");require(["filter_signature/signingjs"],function(d){if(d.debug){console.log("end",b)}c.preventDefault();c.stopPropagation();d.drawing=false})},eventStopBody:function(c){var b=a(this).attr("data-uniqid");require(["filter_signature/signingjs"],function(d){if(d.debug){console.log("bodystart",this)}if(typeof b!=="undefined"){if(c.target==d.canvas[b]){c.preventDefault();c.stopPropagation()}}})},}});window.requestAnimFrame=(function(a){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(b){window.setTimeout(b,1000/60)}})();