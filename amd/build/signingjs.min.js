define(["jquery"],function(a){return{mousePressed:undefined,lastX:undefined,lastY:undefined,ctx:undefined,canvas:undefined,drawing:undefined,mousePos:undefined,lastPos:undefined,isMobile:undefined,init:function(e){var b=this;b.uniqid=e;console.log("filter_signature/signingjs:initialize(uniqid)",b.uniqid);if(document.getElementById("image-"+b.uniqid)!=null){var d=document.getElementById("image-"+b.uniqid);d.setAttribute("height",d.offsetWidth/1000*320);return}b.canvas=document.getElementById("canvas-"+b.uniqid);b.canvas.setAttribute("height",b.canvas.offsetWidth/1000*320);b.canvas.setAttribute("data-uniqid",b.uniqid);b.ctx=b.canvas.getContext("2d");var c=b.canvas.getBoundingClientRect();b.canvas.width=c.width;b.canvas.height=c.height;b.canvas.strokeStyle="#000";b.canvas.lineWidth=1;b.drawing=false;b.mousePos={x:0,y:0};b.lastPos=b.mousePos;b.isMobile=("ontouchstart" in window)||window.DocumentTouch&&document instanceof DocumentTouch;a("#clearCanvas-"+b.uniqid).bind("click",function(){console.log("Cleared",b.uniqid);b.clearCanvas(b.canvas,ctx)});a("#id_submitbutton-"+b.uniqid).click(function(){console.log("Submitted",b.uniqid);var f=a("#contextid-"+b.uniqid).val();var h=a("#subkey-"+b.uniqid).val();var g=a("#canvas-"+b.uniqid)[0].toDataURL();a("#id_signing-"+b.uniqid).val(g);require(["core/ajax"],function(i){i.call([{methodname:"filter_signature_sign",args:{contextid:f,subkey:h,signature:g},done:function(j){console.log("Answer is ",j)},fail:function(){}}])})});b.canvas.addEventListener((b.isMobile?"touchstart":"mousedown"),function(f){console.log("start");f.preventDefault();f.stopPropagation();b.drawing=true;b.lastPos=b.getMousePos(b.canvas,f);b.mousePos=b.lastPos});b.canvas.addEventListener((b.isMobile?"touchmove":"mousemove"),function(f){console.log("move");f.preventDefault();f.stopPropagation();b.mousePos=b.getMousePos(b.canvas,f)});b.canvas.addEventListener((b.isMobile?"touchend":"mouseup"),function(f){console.log("end");f.preventDefault();f.stopPropagation();b.drawing=false});document.body.addEventListener("touchstart",function(f){console.log("bodystart");if(f.target==b.canvas){f.preventDefault();f.stopPropagation()}},false);document.body.addEventListener("touchend",function(f){console.log("bodyend");if(f.target==b.canvas){f.preventDefault();f.stopPropagation()}},false);document.body.addEventListener("touchmove",function(f){console.log("bodymove");if(f.target==b.canvas){f.preventDefault();f.stopPropagation()}},false);a(window).on("resize",function(){var f=b.canvas.width,h=b.canvas.height;var g=b.ctx.getImageData(0,0,f,h);var i=b.canvas.getBoundingClientRect();b.canvas.width=i.width;b.canvas.height=i.height;f=b.canvas.width,h=b.canvas.height;b.ctx.putImageData(g,0,0)})},save:function(){initialize()},getMousePos:function(b,c){var d=b.getBoundingClientRect();return{x:(handler.isMobile?c.touches[0].clientX:c.clientX)-d.left,y:(handler.isMobile?c.touches[0].clientY:c.clientY)-d.top}},renderCanvas:function(){if(handler.drawing){handler.ctx.moveTo(handler.lastPos.x,handler.lastPos.y);handler.ctx.lineTo(handler.mousePos.x,handler.mousePos.y);handler.ctx.stroke();handler.lastPos=handler.mousePos}},clearCanvas:function(c,b){b.clearRect(0,0,c.width,c.height);c.width=c.width},downloadCanvas:function(){this.href=handler.canvas.toDataURL()},}});window.requestAnimFrame=(function(a){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(b){window.setTimeout(b,1000/60)}})();