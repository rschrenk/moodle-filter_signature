filter_signing_handler=[];define(["jquery"],function(a){return{uniqid:undefined,mousePressed:undefined,lastX:undefined,lastY:undefined,ctx:undefined,canvas:undefined,drawing:undefined,mousePos:undefined,lastPos:undefined,isMobile:undefined,init:function(d){this.uniqid=d;filter_signing_handler[d]=this;a("#canvas-"+d).attr("data-uniqid",d);console.log("Signing handlers are",filter_signing_handler);handler=this;console.log("filter_signature/signingjs:initialize(uniqid)",handler.uniqid);if(document.getElementById("image-"+handler.uniqid)!=null){var c=document.getElementById("image-"+handler.uniqid);return}handler.canvas=document.getElementById("canvas-"+handler.uniqid);handler.canvas.setAttribute("data-uniqid",handler.uniqid);handler.ctx=handler.canvas.getContext("2d");var b=handler.canvas.getBoundingClientRect();console.log("set bounds to ",b);handler.canvas.width=b.width;handler.canvas.height=b.height;handler.canvas.strokeStyle="#000";handler.canvas.lineWidth=1;handler.drawing=false;handler.mousePos={x:0,y:0};handler.lastPos=handler.mousePos;handler.isMobile=("ontouchstart" in window)||window.DocumentTouch&&document instanceof DocumentTouch;a("#clearCanvas-"+handler.uniqid).bind("click",function(){console.log("Cleared",handler.uniqid);handler.clearCanvas(handler.canvas,ctx)});a("#id_submitbutton-"+handler.uniqid).click(function(){var e=a("#contextid-"+handler.uniqid).val();var g=a("#subkey-"+handler.uniqid).val();var f=a("#canvas-"+handler.uniqid)[0].toDataURL();console.log("Submitted",handler.uniqid,e,g,f);a("#id_signing-"+handler.uniqid).val(f);require(["core/ajax"],function(h){h.call([{methodname:"filter_signature_sign",args:{contextid:e,subkey:g,signature:f},done:function(i){console.log("Answer is ",i)},fail:function(){}}])})});handler.canvas.addEventListener((handler.isMobile?"touchstart":"mousedown"),handler.eventStart);handler.canvas.addEventListener((handler.isMobile?"touchmove":"mousemove"),handler.eventMove);handler.canvas.addEventListener((handler.isMobile?"touchend":"mouseup"),handler.eventStop);document.body.addEventListener("touchstart",handler.eventStartBody,false);document.body.addEventListener("touchmove",handler.eventMoveBody,false);document.body.addEventListener("touchend",handler.eventStopBody,false);a(window).on("resize",function(){var e=handler.canvas.width,g=handler.canvas.height;var f=handler.ctx.getImageData(0,0,e,g);var h=handler.canvas.getBoundingClientRect();handler.canvas.width=h.width;handler.canvas.height=h.height;e=handler.canvas.width,g=handler.canvas.height;handler.ctx.putImageData(f,0,0)})},getMousePos:function(d,b,c){var e=b.getBoundingClientRect();return{x:(d.isMobile?c.touches[0].clientX:c.clientX)-e.left,y:(d.isMobile?c.touches[0].clientY:c.clientY)-e.top}},renderCanvas:function(b){console.log("renderCanvas",b.uniqid);if(b.drawing){b.ctx.moveTo(b.lastPos.x,b.lastPos.y);b.ctx.lineTo(b.mousePos.x,b.mousePos.y);b.ctx.stroke();b.lastPos=b.mousePos}},clearCanvas:function(c,b){b.clearRect(0,0,c.width,c.height);c.width=c.width},eventStart:function(b){uniqid=a(this).attr("data-uniqid");handler=filter_signing_handler[uniqid];b.preventDefault();b.stopPropagation();if(typeof handler!=="undefined"){handler.drawing=true;handler.lastPos=handler.getMousePos(handler,handler.canvas,b);handler.mousePos=handler.lastPos}else{console.error("No handler found for uniqid",uniqid)}},eventStartBody:function(b){uniqid=a(b).attr("data-uniqid");if(typeof uniqid!=="undefined"){handler=filter_signing_handler[uniqid];if(b.target==handler.canvas){b.preventDefault();b.stopPropagation()}}},eventMove:function(b){uniqid=a(this).attr("data-uniqid");handler=filter_signing_handler[uniqid];console.log("move",uniqid,handler.uniqid);b.preventDefault();b.stopPropagation();if(typeof handler!=="undefined"){handler.mousePos=handler.getMousePos(handler,handler.canvas,b);if(handler.drawing){handler.renderCanvas(handler)}}else{console.error("No handler found for uniqid",uniqid)}},eventMoveBody:function(b){uniqid=a(b).attr("data-uniqid");if(typeof uniqid!=="undefined"){handler=filter_signing_handler[uniqid];if(b.target==handler.canvas){b.preventDefault();b.stopPropagation()}}},eventStop:function(b){uniqid=a(this).attr("data-uniqid");handler=filter_signing_handler[uniqid];b.preventDefault();b.stopPropagation();if(typeof handler!=="undefined"){handler.drawing=false}else{console.error("No handler found for uniqid",uniqid)}},eventStopBody:function(b){uniqid=a(b).attr("data-uniqid");if(typeof uniqid!=="undefined"){handler=filter_signing_handler[uniqid];if(b.target==handler.canvas){b.preventDefault();b.stopPropagation()}}},}});window.requestAnimFrame=(function(a){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(b){window.setTimeout(b,1000/60)}})();